import s from"node:fs";import r from"node:path";import{NodeResolvePlugin as f}from"@esbuild-plugins/node-resolve";import{defineConfig as m}from"tsup";const o=r.resolve(process.cwd(),"../../","packages/ridb-core"),l={name:"wasm",setup(e){e.onResolve({filter:/\.wasm$/},t=>s.existsSync(r.resolve(o,t.path))?{path:r.resolve(o,t.path),namespace:"wasm"}:{path:r.resolve("../../node_modules",t.path),namespace:"wasm"}),e.onLoad({filter:/.*/,namespace:"wasm"},async t=>({contents:`export default Buffer.from("${(await s.promises.readFile(t.path)).toString("base64")}", "base64")`,loader:"js"}))}},p=[f({extensions:[".ts",".js",".wasm"],onResolved:e=>e.includes("node_modules")?{external:!0}:e})];function u({format:e,entry:t,banner:n,platform:a}){return m(({watch:c})=>({entry:t,format:e,outDir:"build",target:"esnext",minify:!1,clean:!1,esbuildPlugins:[l,...p],banner:n,esbuildOptions:(i,d)=>{i.platform=a||"neutral"},external:["buffer","next","vitest","react-server-dom-webpack","tsup","react-server-dom-webpack/client.edge","@trust0/ridb/worker"]}))}export{u as default,p as plugins,l as wasmPlugin};
