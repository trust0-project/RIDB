import{defineConfig as o}from"tsup";import{NodeResolvePlugin as i}from"@esbuild-plugins/node-resolve";import a from"fs";import r from"path";const s=r.resolve(process.cwd(),"../../","packages/ridb-core"),f={name:"wasm",setup(e){e.onResolve({filter:/\.wasm$/},t=>a.existsSync(r.resolve(s,t.path))?{path:r.resolve(s,t.path),namespace:"wasm"}:{path:r.resolve("../../node_modules",t.path),namespace:"wasm"}),e.onLoad({filter:/.*/,namespace:"wasm"},async t=>({contents:`export default Buffer.from("${(await a.promises.readFile(t.path)).toString("base64")}", "base64")`,loader:"js"}))}},m=[i({extensions:[".ts",".js",".wasm"],onResolved:e=>e.includes("node_modules")?{external:!0}:e})];function p({format:e,entry:t}){return o(({watch:n})=>({entry:t,format:e,outDir:"build",target:"esnext",minify:!1,clean:!1,esbuildPlugins:[f,...m],external:["buffer","next","vitest","react-server-dom-webpack","tsup","react-server-dom-webpack/client.edge"]}))}export{p as default,m as plugins,f as wasmPlugin};
